const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lclayout-6cdRR6IH.js","assets/_commonjsHelpers-DCkdB7M8.js"])))=>i.map(i=>d[i]);
import{a8 as le,vp as K,H as et,fB as P,e as H,it as dt,il as ut,dx as ct,ca as Ne,_ as yt,iS as ht,vm as tt,bL as st,dk as it,dn as J,aH as mt,fT as pe,ig as Q,fU as ie,a7 as de,kV as ve,az as rt,n as y,q as h,v as ye,nO as nt,pV as ft,pW as gt,nP as at,q0 as bt,zp as wt,sg as Tt,qI as Y,bU as re,zq as ne,al as Se,jS as It,qM as Et,sX as Le,c7 as _t,dT as $t,qy as Nt,qz as vt,qA as St,iX as Lt,qx as Mt,iY as kt,iZ as Dt,i_ as Ct,c as xt,k as Ft,zr as Rt,eq as oe,iR as ee,qC as At,nQ as Ot,f0 as Me,pU as ke,pY as jt,dC as qt,qD as Pt,b5 as Gt,cc as Ut,dB as A,zs as zt,zt as Ht,zu as Qt,uB as Wt,zv as Bt,zw as Vt,jo as Jt,qV as Zt,qW as Yt,qJ as Kt,zx as Xt,p$ as es,f1 as ts,qK as ss,sO as is,a9 as rs,w8 as ns,qH as as}from"./index-JOCrQyYq.js";import{i as Ie,r as os,n as Ee,a as Z,l as ls,V as ps}from"./knowledgeGraphService-lnV2x-cn.js";import{I as ue,t as ce,_ as R,E as ae,S as _e,o as be}from"./constants-SxxbBSOD.js";import{p as B,a as De,i as Ce}from"./GraphQueryStreaming-CSMDnS2J.js";import{f as ds}from"./FeatureStore-BKRkb_1h.js";import{W as us}from"./QueryEngine-BJrtXHUd.js";import{u as xe}from"./clientSideDefaults-0liyLamn.js";import{s as cs,t as ys}from"./QueryEngineCapabilities-DJC_YILC.js";let hs=class{constructor(){this.version="",this.queryResult=new ms}},ms=class{constructor(){this.featureResult=new fs}},fs=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new gs,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new bs,this.geometryType=null,this.spatialReference=new le,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new ot,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},gs=class{constructor(){this.name="",this.isSystemMaintained=!1}},bs=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},ot=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new ws,this.translate=new Ts}},ws=class{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}},Ts=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},Is=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},Es=class{constructor(){this.attributes=[],this.compressedGeometry=new we,this.centroid=new we,this.aggregateGeometries=[]}},we=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};const _s=["ELEMENTUID","TYPENAME"],$s={upperLeft:0,lowerLeft:1},Ns={sqlTypeBigInt:0,sqlTypeBinary:1,sqlTypeBit:2,sqlTypeChar:3,sqlTypeDate:4,sqlTypeDecimal:5,sqlTypeDouble:6,sqlTypeFloat:7,sqlTypeGeometry:8,sqlTypeGUID:9,sqlTypeInteger:10,sqlTypeLongNVarchar:11,sqlTypeLongVarbinary:12,sqlTypeLongVarchar:13,sqlTypeNChar:14,sqlTypeNVarChar:15,sqlTypeOther:16,sqlTypeReal:17,sqlTypeSmallInt:18,sqlTypeSqlXml:19,sqlTypeTime:20,sqlTypeTimestamp:21,sqlTypeTimestamp2:22,sqlTypeTinyInt:23,sqlTypeVarbinary:24,sqlTypeVarchar:25};function vs(t){const e=new hs;e.version=t.version;const s=t.get_query_result();if(s.results_type.value!==0)throw new Error("Got a non-feature collection type");const i=s.get_feature_result(),r=e.queryResult.featureResult;r.objectIdFieldName=i.objectid_field_name,r.exceededTransferLimit=i.exceeded_transfer_limit,r.hasM=i.has_m,r.hasZ=i.has_z,r.geometryType=K(Ie,i.geometry_type.value),r.globalIdFieldName=i.globalid_field_name,r.geohashFieldName=i.geohash_field_name;const n=r.uniqueIdField,l=i.unique_id_field;n.name=l.name,n.isSystemMaintained=l.isSystemMaintained;const d=r.geometryProperties,c=i.geometry_properties;d.shapeAreaFieldName=c.shapeAreaFieldName,d.shapeLengthFieldName=c.shapeLengthFieldName,d.units=c.units;const m=r.spatialReference,a=i.spatial_reference;m.wkid=a.wkid,m.latestWkid=a.latestWkid,m.vcsWkid=a.vcsWkid,m.latestVcsWkid=a.latestVcsWkid,m.wkt=a.wkt,r.transform=Ls(i.transform);const o=r.fields,p=r.fieldNameToAttributeIndexMap,u=i.fields,b=u.size();for(let _=0;_<b;_++){const $=u.get(_),L=lt($);o.push(L),p[L.name]=_,$.delete()}u.delete();const T=r.values,g=i.values_count();for(let _=0;_<g;_++)T.push(i.get_value_at(_));const v=r.features,E=i.features,M=E.size();if(M>0){for(const _ of _s)if(p[_]===void 0)throw new Error(`Feature collection missing required attribute: ${_}`)}for(let _=0;_<M;_++){const $=new Es,L=E.get(_),j=$.attributes,G=L.attributes_count();for(let F=0;F<G;F++)j.push(L.get_attribute_at(F));const U=L.get_compressed_geometry();U&&($.compressedGeometry=me(U),$.centroid=me(L.get_centroid()));const D=$.aggregateGeometries,C=L.aggregate_geometries,x=C.size();for(let F=0;F<x;F++){const k=C.get(F),X=me(k);D.push(X),k.delete()}C.delete(),v.push($),L.delete()}E.delete();const N=r.geometryFields,S=i.geometry_fields,w=S.size();for(let _=0;_<w;_++){const $=S.get(_),L=Ss($);N.push(L),$.delete()}return S.delete(),e}function me(t){const e=new we;e.geometryType=K(Ie,t.geometry_type.value);const s=[],i=[];for(let r=0;r<t.lengths.length;r++)s.push(t.lengths[r]);for(let r=0;r<t.coords.length;r++)i.push(t.coords[r]);return e.lengths=s,e.coords=i,e}function lt(t){const e=new Is;return e.name=t.name,e.alias=t.alias,e.fieldType=K(os,t.field_type.value),e.sqlType=K(Ns,t.sql_type.value),e.domain=t.domain,e.defaultValue=t.default_value,e}function Ss(t){const e=lt(t);return e.geometryType=K(Ie,t.geometry_type.value),e}function Ls(t){const e=new ot;e.quantizeOriginPosition=K($s,t.quantizeOriginPosition.value);const s=e.scale,i=t.scale;s.xScale=i.xScale,s.yScale=i.yScale,s.mScale=i.mScale,s.zScale=i.zScale;const r=e.translate,n=t.translate;return r.xTranslate=n.xTranslate,r.yTranslate=n.yTranslate,r.mTranslate=n.mTranslate,r.zTranslate=n.zTranslate,e}async function Ms(t){const e=[],s={generateAllSublayers:!1,namedTypeDefinitions:new Map};return t.entitiesUrl&&e.push(Fe(t.entitiesUrl).then(i=>{Re(i,s)})),t.relationshipsUrl&&e.push(Fe(t.relationshipsUrl).then(i=>{Re(i,s)})),await Promise.all(e),s}async function vi(t,e){e??=!1;const s={generateAllSublayers:e,namedTypeDefinitions:new Map};return await Cs(t).then(i=>{Fs(i,s)}),s}async function Si(t){const e=await Ee(),s=new e.MapOfObjectIdentifierSets;ks(s,e,t);const i=new e.MapOfObjectIdentifierSetsEncoder;try{i.set_map_of_identifier_sets(s),i.encode();const r=i.get_encoding_result();if(r.error.error_code!==0)throw new H("knowledge-graph:layer-support-utils",r.error.error_message);const n=structuredClone(r.get_byte_buffer());return i.delete(),n}finally{s.delete()}}function ks(t,e,s){for(const[i,r]of s.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const n=r.members.keys();let l=!1,d=!0;const c=new e.ObjectIdArray,m=new e.StringArray,a=new e.GlobalIdArray,o=new e.IdentifierArray,p=new e.ObjectIdentifierSet;for(const u of n)d&&(l=!isNaN(Number(u)),d=!1),l?c.add_objectid(Number(u)):(m.add_string(u),a.add_globalid(u)),o.add_identifier(u);p.set_oid_array(c),p.set_string_array(m),p.set_globalid_array(a),p.set_identifier_array(o),c.delete(),m.delete(),a.delete(),o.delete(),t.put_identifier_set(i,p),p.delete()}return t}async function Fe(t){const e=await et(t,{responseType:"array-buffer"});return Ds(await e.data)}async function Ds(t){const e=new(await Ee()).FeatureCollectionDecoder,s=e.decode(new Uint8Array(t));if(s.error_code!==0)throw new H("knowledge-graph:layer-support-utils",s.error_message);const i=e.get_feature_collection(),r=vs(i);return e.delete(),r}async function Cs(t){const e=await et(t,{responseType:"array-buffer"}),s=await e.data;return xs(new Uint8Array(s))}async function xs(t){const e=new(await Ee()).MapOfObjectIdentifierSetsDecoder,s=e.decode(new Uint8Array(t)),i=new Map;if(s.error_code!==0)throw new H("knowledge-graph:layer-support-utils",s.error_message);const r=e.get_map_of_identifier_sets(),n=r.keys,l=n.size();for(let d=0;d<l;d++){const c=n.get(d),m=r.query_identifier_set(c),a=[];if(m.id_array_type.value===1){const o=m.get_globalid_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_globalid_at(u))}else if(m.id_array_type.value===3){const o=m.get_identifier_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_identifier_at(u).toString())}else if(m.id_array_type.value===2){const o=m.get_string_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_string_at(u))}else{if(m.id_array_type.value!==0)throw new H("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const o=m.get_oid_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_objectid_at(u).toString())}}i.set(c,a)}return e.delete(),i}function Re(t,e){if(!t?.queryResult?.featureResult)return e;const s=t.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const i of t.queryResult.featureResult.features){const r=i.attributes[s.TYPENAME],n=P(e.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map})),l=i.attributes[s.ELEMENTUID];if(i.compressedGeometry?.coords?.length>0){let d=i.compressedGeometry.lengths;i.compressedGeometry.geometryType==="esriGeometryPoint"&&(d=[]),n.members.set(l,{id:l,linkChartLocation:new dt(d,i.compressedGeometry.coords)})}else n.members.set(l,{id:l})}return e}function Fs(t,e){for(const[s,i]of t){const r=P(e.namedTypeDefinitions,s,()=>({useAllData:!1,members:new Map}));for(const n of i)r.members.has(n)||r.members.set(n,{id:n})}return e}const Li={fetchAndConvertSerializedLinkChart:t=>Ms(t)},Te=(t,e)=>{if(t.type==="column-reference")return t.column===e.systemOidFieldName?"ID(n)":`n.${t.column}`;if(t.type==="string")return`'${t.value}'`;if(t.type==="number")return`${t.value}`;if(t.type==="binary-expression"&&e.supportedSqlTypes.has(t.left.type)&&e.supportedSqlTypes.has(t.right.type)&&e.supportedSqlOperators.has(t.operator))return`${Te(t.left,e)} ${t.operator} ${Te(t.right,e)}`;if(t.type==="binary-expression"&&t.operator==="LIKE"){let s="";if(t.left.type==="function"&&t.left.args.value[0].type==="column-reference")s+=`lower(n.${t.left.args.value[0].column})`;else{if(t.left.type!=="column-reference")return e.unsupportedOperationFound=!0,"";s+=`lower(n.${t.left.column})`}if(s+=" CONTAINS (",t.right.type!=="string")return e.unsupportedOperationFound=!0,"";{let i=t.right.value;i.startsWith("%")&&(i=i.slice(1)),i.endsWith("%")&&(i=i.slice(0,-1)),s+=`'${i.toLowerCase()}')`}return s}return e.unsupportedOperationFound=!0,""};let fe=class V{constructor(){this._featureLookup=new Map}static getInstance(){return V.instance||(V.instance=new V),V.instance}static resetInstance(){V.instance&&(V.instance=null)}deleteFromStore(e){e.forEach(s=>{this._featureLookup.delete(s)})}readFromStoreByList(e){const s=[];return e.forEach(i=>{const r=this.readFromStoreById(i);r&&s.push(r)}),s}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,s,i){const r=[];return e.forEach(n=>{if(!n?.id)return;n.properties||(n.properties=[]);let l,d=null;if(i&&n.properties[i]&&(d=ut(n.properties[i])),"originId"in n&&"destinationId"in n&&(n.properties[ue]=n.originId,n.properties[ce]=n.destinationId),n.properties[s]=n.id,n.id&&this._featureLookup.has(n.id)&&this._featureLookup.get(n.id).attributes){const c=this._featureLookup.get(n.id),m=JSON.parse(JSON.stringify(Object.assign(c.attributes,n.properties)));i&&n.properties[i]&&(m[i]=ct(n.properties[i])),l=new Ne(d?JSON.parse(JSON.stringify(d)):c?.geometry?JSON.parse(JSON.stringify(c.geometry)):null,m,null,n.properties[s])}else l=new Ne(d?JSON.parse(JSON.stringify(d)):null,n.properties,null,n.properties[s]);this._featureLookup.set(`${n.typeName?`${n.typeName}__${n.id}`:n.id}`,l),r.push(l)}),r}},ge,I=null;function Mi(){return ge||(ge=yt(()=>import("./lclayout-6cdRR6IH.js"),__vite__mapDeps([0,1])).then(t=>t.l).then(({default:t})=>t({locateFile:e=>ht(`esri/libs/linkchartlayout/${e}`)})).then(t=>{Rs(t)}),ge)}function Rs(t){I=t}const Ae={right:0,left:1,top:2,bottom:3},Oe={none:0,"start-only":1,"start-and-end":2};function As(t){const e={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...t?.toJSON(),eventsTicksVisualization:t?.eventsTicksVisualization??"start-and-end"};return{...e,timeDirection:{value:Ae[e.timeDirection]??Ae.right},eventsTicksVisualization:{value:Oe[e.eventsTicksVisualization]??Oe["start-and-end"]}}}function W(t,e,s,i,r,n){const l=s.length,d=r.length,c=Float64Array.BYTES_PER_ELEMENT,m=Uint32Array.BYTES_PER_ELEMENT,a=Uint8Array.BYTES_PER_ELEMENT,o=16,p=o+l*(a+2*c)+d*(2*m),u=I._malloc(p);try{const b=u+o-u%o,T=b+l*c,g=T+l*c,v=g+d*m,E=v+d*m,M=()=>[I.HEAPF64.subarray(b>>3,(b>>3)+l),I.HEAPF64.subarray(T>>3,(T>>3)+l),I.HEAPU32.subarray(g>>2,(g>>2)+d),I.HEAPU32.subarray(v>>2,(v>>2)+d),I.HEAPU8.subarray(E,E+l)],[N,S,w,_,$]=M();N.set(s),S.set(i),w.set(r),_.set(n),$.set(e);const L=t(l,E,b,T,d,g,v);let j=null,G=null;if(L.value===0){const k=I.getLayoutLinksTypes(),X=I.getLayoutLinksVerticesEndIndices(),he=I.getLayoutLinksVertices(),$e=I.countLayoutLinksVertices();!d||k&&X?$e&&!he?L.value=1:(j={types:new Uint8Array(I.HEAPU8.subarray(k,k+d)),vertexEndIndex:new Uint32Array(I.HEAPU32.subarray(X>>2,(X>>2)+d)),vertices:new Float64Array(I.HEAPF64.subarray(he>>3,(he>>3)+2*$e))},G=I.getAuxiliaryGraphicElements()):L.value=1}const[U,D,C,x,F]=M();return s.set(U),i.set(D),r.set(C),n.set(x),e.set(F),{status:L.value,links:j,graphics:G}}finally{I._free(u),I.cleanupLayout()}}const je=2,qe=1,Pe=-1;var Ge,Ue,ze,He,Qe,We,Be;(function(t){function e(){return I.getMinIdealEdgeLength()}function s(i,r,n,l,d,c,m=je,a=qe,o=Pe){return W((p,u,b,T,g,v,E)=>I.applyForceDirectedLayout(i,p,u,b,T,g,v,E,m,a,o),r,n,l,d,c)}t.getMinIdealEdgeLength=e,t.apply=s})(Ge||(Ge={})),(function(t){function e(s,i,r,n,l,d,c=je,m=qe,a=Pe){return W((o,p,u,b,T,g,v)=>I.applyCommunityLayout(s,o,p,u,b,T,g,v,c,m,a),i,r,n,l,d)}t.apply=e})(Ue||(Ue={})),(function(t){function e(s,i,r,n,l,d){return W((c,m,a,o,p,u,b)=>I.applySimpleLayout(s,c,m,a,o,p,u,b),i,r,n,l,d)}t.apply=e})(ze||(ze={})),(function(t){function e(s,i,r,n,l,d){return W((c,m,a,o,p,u,b)=>I.applyHierarchicalLayout(s,c,m,a,o,p,u,b),i,r,n,l,d)}t.apply=e})(He||(He={})),(function(t){function e(s,i,r,n,l,d){return W((c,m,a,o,p,u,b)=>I.applyRadialTreeLayout(s,c,m,a,o,p,u,b),i,r,n,l,d)}t.apply=e})(Qe||(Qe={})),(function(t){function e(s,i,r,n,l,d){return W((c,m,a,o,p,u,b)=>I.applySmartTreeLayout(s,c,m,a,o,p,u,b),i,r,n,l,d)}t.apply=e})(We||(We={})),(function(t){function e(s,i,r,n,l,d,c,m,a,o,p,u){return W((b,T,g,v,E,M,N)=>{if(l.length!==b)return{value:1};if(d.length!==b)return{value:1};if(a.length!==E)return{value:1};if(o.length!==E)return{value:1};const S=Float64Array.BYTES_PER_ELEMENT,w=16,_=I._malloc(w+b*S),$=I._malloc(w+b*S),L=I._malloc(w+E*S),j=I._malloc(w+E*S),G=_+w-_%w,U=$+w-$%w,D=L+w-L%w,C=j+w-j%w;try{return I.HEAPF64.subarray(G>>3,(G>>3)+b).set(l),I.HEAPF64.subarray(U>>3,(U>>3)+b).set(d),I.HEAPF64.subarray(D>>3,(D>>3)+E).set(a),I.HEAPF64.subarray(C>>3,(C>>3)+E).set(o),I.applyChronologicalLayout(s,b,T,g,v,G,U,E,M,N,D,C,p,As(u))}finally{I._free(_),I._free($),I._free(L),I._free(j)}},i,r,n,c,m)}t.apply=e})(Be||(Be={}));tt()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"});tt()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Os=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function js(t,e){const s=new Map;if(e.dataModel?.relationshipTypes)for(const i of e.dataModel.relationshipTypes)i.name&&s.set(i.name,[]);for(const i of t)s.has(i.typeName)&&s.get(i.typeName)?.push(i.id);return s}async function ki(t,e,s){const i=[],r=js(t,e),n={},l=[];for(const[a,o]of r){if(o.length<1)continue;const p=`${a}_ids`;n[p]=o,l.push(`MATCH (n)-[r:${a}]->(m) WHERE id(r) in $${p} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(l.length===0)return[];const d=l.join(" UNION "),c=new B({openCypherQuery:d,bindParameters:n}),m=(await Z(e,c,s?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:a,value:o}=await m.read();if(a)break;for(const p of o)i.push({id:p[0],typeName:p[1]}),i.push({id:p[2],typeName:p[3]})}return i}const Di=t=>Os.get(t)??"radial-root-centric";function qs(t){if(!t.spatialReference.isWGS84)throw new H("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return t.clone().normalize().map(e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]])}let q=class extends st{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const s=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(i=>{i.name&&(s.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach(r=>{r.geometryType&&r.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:r.name??"",geometryType:r.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(i=>{i.name&&(s.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach(r=>{r.geometryType&&r.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:r.name??"",geometryType:r.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((i,r)=>{if(s.get(r)==="entity")this.entityTypeNames.add(r);else{if(s.get(r)!=="relationship")return it.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);this.relationshipTypeNames.add(r)}const n=new Map;i.members?.forEach(l=>{P(this.memberIdTypeLookup,l.id,()=>new Set).add(r)}),this.sublayerCaches.set(r,n)})}addToLayer(e){e.forEach(({typeName:s,id:i})=>{if(!this.inclusionModeDefinition)throw new H("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(s)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(s)){const r=this.inclusionModeDefinition.namedTypeDefinitions.get(s);r.members||(r.members=new Map),r.members.set(i,{id:i}),P(this.memberIdTypeLookup,i,()=>new Set).add(s)}}else{const r=new Map;r.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(s,{useAllData:!1,members:r}),P(this.memberIdTypeLookup,i,()=>new Set).add(s)}})}getById(e){return fe.getInstance().readFromStoreById(e)}async getData(e,s,i){if(s.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(s.objectType.name))return[];let r;if(r=e||new J({where:"1=1",outFields:["*"]}),s.parentCompositeLayer.type==="link-chart"){const n=s.parentCompositeLayer,l=this._processingCacheUpdatesLookup.get(s.objectType.name??""),d=r.outFields;d&&d.length===1&&d[0]===R&&r.where==="1=1"||await Promise.all(l??[]);const c=this.sublayerCaches.has(s.objectType.name??"")?Array.from(this.sublayerCaches.get(s.objectType.name)?.values()):[],m=[];return c.forEach(a=>{if(this.relationshipTypeNames.has(s.objectType.name)){a.geometry=n.relationshipLinkChartDiagramLookup.get(a.attributes[s.objectIdField]);const o=this.memberIdTypeLookup.get(a.attributes[ue]),p=this.memberIdTypeLookup.get(a.attributes[ce]),u=this._isEndEntitySpatial(o,a,ue),b=this._isEndEntitySpatial(p,a,ce);a.attributes[ae]=Number(u&&b)}else{a.geometry=n.entityLinkChartDiagramLookup.get(a.attributes[s.objectIdField]);const o=this.geographicLookup.get(s.objectType.name);o&&a.attributes[o.name]?a.attributes[ae]=1:a.attributes[ae]=0}a.attributes[_e]=a.geometry,m.push(a)}),m}return this.retrieveDataFromService(r,s,i)}async getConnectedRecordIds(e,s,i){const r=[];let n="";const l=this._getNamedTypeIdMapFromNodeIds(e);if(s&&s?.length!==0){for(const o of s)n=n+o+"|";n=n.slice(0,-1)}const d={},c=[];for(const[o,p]of l){const u=`${o}_ids`;d[u]=p,s&&s?.length!==0?c.push(`MATCH (n:${o}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r:${n}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):c.push(`MATCH (n:${o}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!c.length)return r;const m=c.join(" UNION "),a=(await Z(this.knowledgeGraph,new B({openCypherQuery:m,bindParameters:d}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:o,value:p}=await a.read();if(o)break;for(let u=0;u<p.length;u++){const b=p[u];r.push({id:b[0],typeName:b[1]}),r.push({id:b[2],typeName:b[3]})}}return r}async getRelationshipsBetweenNodes(e,s,i){const r=this._getNamedTypeIdMapFromNodeIds(e);if(r.size===0)return[];const n={relationshipExclusionIds:s,possibleConnectionEntityIds:e},l=[];for(const[a,o]of r.entries()){const p=`${a}_ids`;n[p]=o,l.push(`MATCH (n:${a}) WHERE id(n) IN $${p} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const d=l.join(" UNION "),c=[],m=(await Z(this.knowledgeGraph,new B({openCypherQuery:d,bindParameters:n}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:a,value:o}=await m.read();if(a)break;for(let p=0;p<o.length;p++){const u=o[p];c.push({id:u[0],typeName:u[1]})}}return c}async getRelationshipsFromNodes(e,s,i,r){const n=this._getNamedTypeIdMapFromNodeIds(e);if(n.size===0||s.length===0)return[];const l={relationshipExclusionIds:i,possibleConnectionEntityIds:s},d=[];for(const[p,u]of n.entries()){const b=`${p}_ids`;l[b]=u,d.push(`MATCH (n:${p}) WHERE id(n) IN $${b} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const c=d.join(" UNION "),m=new Map,a=(await Z(this.knowledgeGraph,new B({openCypherQuery:c,bindParameters:l}),{signal:r?.signal})).resultRowsStream.getReader();for(;;){const{done:p,value:u}=await a.read();if(p)break;for(let b=0;b<u.length;b++){const T=u[b];let g=m.get(T[1]);g||(g=new Set,m.set(T[1],g)),g.add(T[0])}}const o=[];for(const[p,u]of m)for(const b of u)o.push({id:b,typeName:p});return o}async refreshCacheContent(e,s,i,r=!0,n){const l=fe.getInstance(),d=[],c=new Map,m=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&m.set(a.name,a)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&m.set(a.name,a)}),e||this.inclusionModeDefinition?e?e.forEach(a=>{if(this.memberIdTypeLookup.has(a))for(const o of this.memberIdTypeLookup.get(a))c.has(o)?c.get(o)?.push(a):c.set(o,[a])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,o)=>{a.useAllData?c.set(o,null):a.members&&a.members.forEach(p=>{c.has(o)&&c.get(o)!==null?c.get(o)?.push(p.id):c.set(o,[p.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&c.set(a.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&c.set(a.name,null)}));for(const[a,o]of c){const p=new Set(o),u=new Promise((b,T)=>{(async()=>{const v=new Set,E=[];let M,N="",S=!1;if(s||m.get(a)?.properties?.forEach($=>{$.name&&v.add($.name)}),i&&this.geographicLookup.has(a)){const $=this.geographicLookup.get(a)?.name;$&&v.add($)}if(this.entityTypeNames.has(a))N=`MATCH (n:${a}) ${o?"WHERE id(n) IN $ids ":""}return ID(n)`,v.forEach($=>{N+=`, n.${$}`,E.push($)});else{if(!this.relationshipTypeNames.has(a))throw new H("knowledge-graph:layer-data-manager",`The graph type of ${a} could not be determined. Was this type set in the KG data model and inclusion definition?`);S=!0,N=`MATCH ()-[n:${a}]->() ${o?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,v.forEach($=>{N+=`, n.${$}`,E.push($)})}M=new B(o?{openCypherQuery:N,bindParameters:{ids:o}}:{openCypherQuery:N});const w=(await Z(this.knowledgeGraph,M,{signal:n?.signal})).resultRowsStream.getReader();for(;;){const{done:$,value:L}=await w.read();if($)break;const j=[];for(let D=0;D<L.length;D++){const C=L[D];let x=0,F=0;const k={properties:{}};for(k.id=C[x],x++,F++,S&&(k.originId=C[x],x++,F++,k.destinationId=C[x],x++,F++,P(this.nodeConnectionsLookup,k.originId,()=>new Set).add(k.id),P(this.nodeConnectionsLookup,k.destinationId,()=>new Set).add(k.id),P(this.relationshipConnectionsLookup,k.id,()=>[k.originId,k.destinationId]));x<C.length;x++)k.properties[E[x-F]]=C[x];p.delete(k.id),j.push(k)}const G=l.writeToStore(j,R,this.geographicLookup.get(a)?.name);this.sublayerCaches.has(a)||this.sublayerCaches.set(a,new Map),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(a)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(a,{useAllData:!1,members:new Map}),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(a).members=new Map);const U=this.sublayerCaches.get(a);G.forEach(D=>{U?.set(D.attributes[R],D),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.has(D.attributes[R])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.set(D.attributes[R],{id:D.attributes[R]}),P(this.memberIdTypeLookup,D.attributes[R],()=>new Set).add(a))})}const _=this.inclusionModeDefinition?.namedTypeDefinitions.get(a);if(_)for(const $ of p)_.members?.delete($)})().then(()=>{b(null)}).catch(v=>{v.name==="AbortError"?b(null):T(v)})});d.push(u),this._processingCacheUpdatesLookup.get(a)?.push(u)}if(await Promise.all(d),n?.signal?.aborted)throw mt()}removeFromLayer(e){const s=new Set,i=new Set(e.map(r=>r.id));for(const r of e)s.add(r.typeName),this.memberIdTypeLookup.get(r.id)?.size===1?this.memberIdTypeLookup.delete(r.id):this.memberIdTypeLookup.get(r.id)?.delete(r.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,l)=>{l===r.typeName&&n.members?.has(r.id)&&n.members.delete(r.id)});s.forEach(r=>{this.sublayerCaches.get(r)?.forEach((n,l)=>{i.has(l)&&this.sublayerCaches.get(r)?.delete(l)})})}async retrieveDataFromService(e,s,i){const r=fe.getInstance(),n=new Set,l=[];let d,c="",m=[];const a=s.graphType==="relationship",o=this.inclusionModeDefinition?.namedTypeDefinitions?.get(s.objectType.name)?.useAllData,p=s.parentCompositeLayer.sublayerIdsCache.get(s.objectType.name);let u=!o&&p?Array.from(p).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(s.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(s.objectType.name)?.useAllData&&e.objectIds!=null&&(u=e.objectIds);else if(e.objectIds!=null&&u&&u.length>0){const T=e.objectIds;e.objectIds=u.filter(g=>T.includes(g))}else if(e.objectIds!=null)u=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(s.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(s.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(s.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=u}if(e.outFields!=null){const T=e.outFields;T.includes("*")?s.fields.forEach(g=>{n.add(g.name)}):T.forEach(g=>{g!==R&&g!==s.geometryFieldName&&n.add(g)})}if(e.geometry!=null){const T=e.geometry;let g;const v=s.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,E=v?.spatialReference,M=v?.serviceCapabilities?.geometryCapabilities;let N=M?.geometryMaxBoundingRectangleSizeX,S=M?.geometryMaxBoundingRectangleSizeY;if(T.type==="point"){let w=T;w.spatialReference?.isWGS84||(await pe(w.spatialReference,Q),w=ie(w,Q)),g=new de({spatialReference:Q,xmin:w.x-1e-4,ymin:w.y-1e-4,xmax:w.x+1e-4,ymax:w.y+1e-4})}else T?.extent?.spatialReference&&!T.spatialReference?.isWGS84?(await pe(T.extent.spatialReference,Q),g=ie(T.extent,Q)):g=T.extent;if(N&&S&&E){if(E.wkid!==4326){const w=new de({spatialReference:E,xmax:N,ymax:S}),_=ie(w,Q);N=_.xmax,S=_.ymax}if(g.xmax-g.xmin>N)throw new H("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${N}° latitude, limit exceeded`);if(g.ymax-g.ymin>S)throw new H("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${S}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const w=await ve(e.where.toUpperCase(),s.fieldsIndex);s.fields.forEach(_=>{w.fieldNames.includes(_.name)&&n.add(_.name)})}c=a?`Match ()-[n:${s.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${s.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${s.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${s.geometryFieldName}) return ID(n)`,s.geometryFieldName&&n.add(s.geometryFieldName),n.forEach(w=>{c+=`, n.${w}`,l.push(w)}),d=new B({openCypherQuery:c,bindParameters:{param_filter_geom:new rt({rings:qs(g)})}})}else{let T="";if(e.where!=null&&e.where!=="1=1"){const E=await ve(e.where,s.fieldsIndex);s.fields.forEach(N=>{E.fieldNames.includes(N.name)&&n.add(N.name)});const M={systemOidFieldName:R,supportedSqlTypes:new Set(["column-reference","string","number","binary-expression"]),supportedSqlOperators:new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]),unsupportedOperationFound:!1};T=Te(E.parseTree,M),M.unsupportedOperationFound&&(T="")}let g="";g=a?`Match ()-[n:${s.objectType.name}]->()`:`Match (n:${s.objectType.name})`;let v=!1;u&&(v=!0,g+=" WHERE ID(n) IN $ids"),T&&(g+=v?" AND":" WHERE",g+=` ${T}`),g+=" return ID(n)",a&&(g+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&s.geometryFieldName&&n.add(s.geometryFieldName),n.forEach(E=>{g+=`, n.${E}`,l.push(E)}),d=new B(u?{openCypherQuery:g,bindParameters:{ids:u}}:{openCypherQuery:g})}const b=(await Z(s.parentCompositeLayer.dataManager.knowledgeGraph,d,i)).resultRowsStream.getReader();for(;;){const{done:T,value:g}=await b.read();if(T)break;const v=[];for(let E=0;E<g.length;E++){const M=g[E];let N=0,S=0;const w={properties:{}};for(w.id=M[N],N++,S++,a&&(w.originId=M[N],N++,S++,w.destinationId=M[N],N++,S++);N<M.length;N++)w.properties[l[N-S]]=M[N];v.push(w)}m=m.concat(r.writeToStore(v,R,s.parentCompositeLayer.dataManager.geographicLookup.get(s.objectType.name)?.name))}return m}_isEndEntitySpatial(e,s,i){for(const r of e??[])if(this.entityTypeNames.has(r)){const n=this.geographicLookup.get(r),l=n&&this.sublayerCaches.get(r)?.get(s.attributes[i]);if(n&&l?.attributes[n.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const s=new Map;return e.forEach(i=>{if(this.memberIdTypeLookup.has(i))for(const r of this.memberIdTypeLookup.get(i)){if(!this.entityTypeNames.has(r))return;s.has(r)?s.get(r)?.push(i):s.set(r,[i])}}),s}};y([h()],q.prototype,"knowledgeGraph",void 0),y([h()],q.prototype,"inclusionModeDefinition",void 0),y([h()],q.prototype,"entityTypeNames",void 0),y([h()],q.prototype,"relationshipTypeNames",void 0),y([h()],q.prototype,"geographicLookup",void 0),y([h()],q.prototype,"sublayerCaches",void 0),y([h()],q.prototype,"nodeConnectionsLookup",void 0),y([h()],q.prototype,"relationshipConnectionsLookup",void 0),y([h()],q.prototype,"memberIdTypeLookup",void 0),q=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],q);const Ps=Symbol("isKnowledgeGraphGraphicOriginSymbol");var Ve;class Gs extends nt{get[(Ve=Ps,ft)](){return this.sublayer}get[gt](){return this.sublayer}get[at](){return this.sublayer}constructor(e,s){super(),this[Ve]=!0,this.type="knowledge-graph",this.layer=e,this.sublayer=s}get id(){return this.layer.id}}const Us=Symbol("isLinkChartGraphicOriginSymbol");var Je;class zs extends nt{get[(Je=Us,at)](){return this.layer}constructor(e,s){super(),this[Je]=!0,this.type="link-chart",this.layer=e,this.sublayer=s}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}}const Ze=bt(),Hs=t=>{const e=t;let s=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return y([h(Ze.fields)],s.prototype,"fields",void 0),y([h(Ze.fieldsIndex)],s.prototype,"fieldsIndex",void 0),s=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],s),s},Qs=wt;let z=class extends st{constructor(t){super(t),this.entityAdds=void 0,this.entityUpdates=void 0,this.entityDeletes=void 0,this.relationshipAdds=void 0,this.relationshipUpdates=void 0,this.relationshipDeletes=void 0,this.options=void 0}};y([h()],z.prototype,"entityAdds",void 0),y([h()],z.prototype,"entityUpdates",void 0),y([h()],z.prototype,"entityDeletes",void 0),y([h()],z.prototype,"relationshipAdds",void 0),y([h()],z.prototype,"relationshipUpdates",void 0),y([h()],z.prototype,"relationshipDeletes",void 0),y([h()],z.prototype,"options",void 0),z=y([ye("esri.rest.knowledgeGraph.GraphApplyEdits")],z);const Ws={initializeLayersFromClientData:async(t,e,s)=>{if(e||(e=[...t.layers,...t.tables].map(n=>n.graphTypeName)),e?.length===0)return;const i=new Map;for(const n of e)i.set(n,Ye(t,n));const r=await ls(t.dataManager.knowledgeGraph,Array.from(i.values()),{requestOptions:{signal:s?.signal}});for(const n of[...t.layers,...t.tables]){const l=n.objectType.name;if(l==null)continue;const d=r.get(Ye(t,l));if(d){const c=JSON.parse(d);c===null||typeof c!="object"||c.hasOwnProperty("showLabels")||(c.showLabels=!1),n.read(c,{origin:"service"})}}}},Ye=(t,e)=>t.type==="knowledge-graph"?`${e}/Map`:`${e}/LinkChart/LinkChartSubLayer`;async function xi(t,e,s){return Ws.initializeLayersFromClientData(t,e,s)}const Ke=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Bs="#8f8f82";function Vs(t){return t<0||t>=Ke.length?new Se(Bs):new Se(Ke[t])}function Js(t){const e=t.toArray();return new It({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:e},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:e}]}}]}]}}})}function Zs(t){let e="ESRI__ID",s=4;for(const i of t)if(i.name){if(i.name.toLowerCase()==="name"){e=i.name;break}i.name.toLowerCase().includes("name")?(e=i.name,s=2):i.fieldType==="esriFieldTypeString"&&s>3&&(e=i.name,s=3)}return e}function Ys(t,e,s){const i={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},r=new Y({labelExpressionInfo:new ne({expression:s==="ESRI__ID"?`${e}`:`$feature.${s}`}),labelPlacement:"above-center",symbol:new re(i)}),n=new Y({labelExpressionInfo:new ne({expression:`'${e}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new re({...i,yoffset:"12px"})});return t==="entity"?[r]:[n]}function Ks(t,e,s){const i={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},r=s==="ESRI__ID"?`${t}`:`$feature.${s}`;return e==="point"?[new Y({labelExpressionInfo:new ne({expression:r}),labelPlacement:"above-center",symbol:new re(i)})]:e==="polyline"?[new Y({labelExpressionInfo:new ne({expression:r}),labelPlacement:"center-along",repeatLabel:!0,symbol:new re(i)})]:e==="polygon"?[new Y({labelExpressionInfo:new ne({expression:r}),labelPlacement:"always-horizontal",symbol:new re(i)})]:null}const Xs={capabilities:[],allowGeometryUpdates:!1,serviceCapabilities:{geometryCapabilities:{supportsZValues:!1,supportsMValues:!1}}};function ei(t){const{capabilities:e,allowGeometryUpdates:s,serviceCapabilities:{geometryCapabilities:{supportsZValues:i,supportsMValues:r}}}=t?.serviceDefinition||Xs,n=t?.dataModel.arcgisManaged?e:e.filter(d=>d==="Query"),l=new Set(n);return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:r,supportsZ:i},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:l.has("Create"),supportsDelete:l.has("Delete"),supportsEditing:l.has("Editing"),supportsChangeTracking:!1,supportsQuery:l.has("Query"),supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:l.has("Update"),supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:ys,queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryAttributeBins:cs,editing:{supportsGeometryUpdate:!!t?.dataModel.arcgisManaged&&s,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:l.has("Delete"),supportsUpdateByAnonymous:!1,supportsUpdateByOthers:l.has("Update"),supportsAsyncApplyEdits:!1,zDefault:void 0}}}async function ti(t,e){const s=new z,i=e.graphTypeName,r=e.graphType,n=e.parentCompositeLayer.type==="knowledge-graph"?e.geometryFieldName:null,l=!!e.fieldsIndex.get(n)?.editable,d=a=>{const o={...a};for(const p of e.fields)p.editable||delete o[p.name];for(const p of Object.keys(a))p.includes("ESRI__")&&delete o[p];return o},c=async a=>{await pe(a.spatialReference,le.WGS84);const o=ie(a,le.WGS84);return o.type==="point"?o.normalize():(await $t(o))[0]};for(const a of t.addFeatures??[]){const o=d(a.attributes);Le(a.sourceLayer)&&a.sourceLayer.graphTypeName===i&&(r==="entity"?(s.entityAdds||(s.entityAdds=[]),n&&a.geometry&&(o[n]=await c(a.geometry)),s.entityAdds.push(new De({properties:o,typeName:i}))):(s.relationshipAdds||(s.relationshipAdds=[]),s.relationshipAdds.push(new Ce({properties:o,typeName:i}))))}for(const a of t.updateFeatures??[]){const o=a.attributes[R],p=d(a.attributes);Le(a.sourceLayer)&&a.sourceLayer.graphTypeName===i&&(r==="entity"?(s.entityUpdates||(s.entityUpdates=[]),n&&l&&a.geometry&&(p[n]=await c(a.geometry)),s.entityUpdates.push(new De({id:o,properties:p,typeName:i}))):(s.relationshipUpdates||(s.relationshipUpdates=[]),s.relationshipUpdates.push(new Ce({id:o,properties:p,typeName:i}))))}const m=new Map;for(const a of t.deleteFeatures??[])if(_t(a)){const o=a,p=P(m,o.sourceLayer.graphTypeName,()=>({typeName:o.sourceLayer.graphTypeName,ids:[]}));o.sourceLayer.graphTypeName===i&&p.ids.push(o.attributes[R])}else a.objectId&&typeof a.objectId=="string"&&P(m,i,()=>({typeName:i,ids:[]})).ids.push(a.objectId);for(const a of m.values())a.ids.length>0&&(r==="entity"?(s.entityDeletes||(s.entityDeletes=[]),s.entityDeletes.push({typeName:a.typeName,ids:a.ids})):(s.relationshipDeletes||(s.relationshipDeletes=[]),s.relationshipDeletes.push({typeName:a.typeName,ids:a.ids})));return s}function si(t,e){const s={addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]};for(const i of t.editResults)if(i.typeName===e){for(const r of i.adds)s.addFeatureResults.push({objectId:r.id,globalId:r.id});for(const r of i.updates)s.updateFeatureResults.push({objectId:r.id,globalId:r.id});for(const r of i.deletes)s.deleteFeatureResults.push({objectId:r.id,globalId:r.id})}return s}function ii(t){if(!t.objectType)return null;const e=[];for(const s of t.fields)!s.name.includes("ESRI__")&&s.editable&&s.type!=="geometry"&&e.push(new Qs({fieldName:s.name}));return new Tt({elements:e})}function ri(t){if(!t.objectType)return null;let e=null;switch(t.geometryType){case"point":case"multipoint":e="point";break;case"polyline":e="line";break;case"polygon":e="polygon";break;default:e=null}return[new Et({name:t.graphTypeName,drawingTool:e,prototype:{}})]}function O(t){if(!t.json)return t;t.json.write=Xe(t.json.write);const e=t.json.origins;if(!e)return t;let s;for(s in e){const i=e[s];i&&(i.write=Xe(i.write))}return t}function Xe(t){return typeof t=="object"&&t?(t.enabled!==!1&&(t.overridePolicy=ni(t)),t):t===!0?te():t}function ni(t){const{target:e,writer:s,overridePolicy:i,...r}=t;return function(n,l){const d=pt.call(this,n,l);return d.enabled?{...r,...d}:d}}function te(){return{overridePolicy:pt}}function pt(t,e){const s=!!this.geometryType;let i={enabled:s};return s&&(i={...i,...se.call(this,t,e)}),i}function se(t,e){return{ignoreOrigin:this.originIdOf(e)>0}}let f=class extends Hs(Nt(vt(St(Lt(Mt(kt(Dt(Ct(xt(Ft)))))))))){constructor(t){super(t),this.blendMode="normal",this.charts=null,this.definitionExpression=null,this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=R,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const e=new MessageChannel;return new Rt(e.port1,{channel:e,client:{queryFeatures:(s,i={})=>{const r=J.fromJSON(s);return this.queryFeaturesJSON(r,i)}}}),[e.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get capabilities(){return this.parent?this.parent.sublayerCapabilities:ei(null)}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}get editingEnabled(){return this._isOverridden("editingEnabled")?this._get("editingEnabled"):this.capabilities.operations.supportsEditing}set editingEnabled(t){this._overrideIfSome("editingEnabled",t)}get isTable(){return this.parentCompositeLayer.type!=="link-chart"&&this.geometryFieldName==null}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(t){const e=this._normalizeFeatureReduction(t);this._set("featureReduction",e)}get fields(){const t=[];return this.objectType?.properties?.forEach(e=>{const s=e.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":e.fieldType;t.push(oe.fromJSON({name:e.name,type:s,alias:e.alias,defaultValue:e.defaultValue,editable:e.editable,nullable:e.nullable}))}),t.push(oe.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),oe.fromJSON({name:be,type:"esriFieldTypeInteger",alias:be,editable:!1}),oe.fromJSON({name:ae,type:"esriFieldTypeInteger",alias:ae,editable:!1})),t}get formTemplate(){return this._isOverridden("formTemplate")?this._get("formTemplate"):ii(this)}set formTemplate(t){this._overrideIfSome("formTemplate",t)}get geometryType(){if(this.parentCompositeLayer?.type==="link-chart")return this.graphType==="relationship"?"polyline":"point";const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.geometryType;return e&&e!=="esriGeometryNull"?ee.fromJSON(e):null}get geometryFieldName(){return this.parentCompositeLayer?.type==="link-chart"?_e:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphicOrigin(){if(!this.parent)return null;switch(this.parent.type){case"knowledge-graph":return new Gs(this.parent,this);case"link-chart":return new zs(this.parent,this)}}get graphTypeName(){return this.objectType?.name}set graphTypeName(t){this._set("graphTypeName",t)}get hasM(){const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.name;return(e?this.objectType?.properties?.[e]:null)?.hasM??!1}get hasZ(){const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.name;return(e?this.objectType?.properties?.[e]:null)?.hasZ??!1}set labelingInfo(t){this._set("labelingInfo",t)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const t=this.objectType.properties?Zs(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?Ys(this.graphType,this.graphTypeName,t):Ks(this.graphTypeName,this.geometryType,t)}set renderer(t){At(t,this.fieldsIndex),this._set("renderer",t)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const t=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,e=[...t?.entityTypes??[],...t?.relationshipTypes??[]].map(r=>r.name).indexOf(this.graphTypeName),s=Vs(e);if(this.parentCompositeLayer?.type==="link-chart"){if(this.graphType==="relationship")return new Ot({type:"simple",symbol:Js(s)});const r=Me(xe(ee.toJSON("point")).renderer);return ke(r.symbol,s),r}const i=Me(xe(ee.toJSON(this.geometryType)).renderer);return ke(i.symbol,s),i}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??le.WGS84}get templates(){return this._isOverridden("templates")?this._get("templates"):ri(this)}set templates(t){this._overrideIfSome("templates",t)}set timeInfo(t){this._set("timeInfo",t)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(t){this._set("title",t)}writeTitle(t,e){e.title=t??"Layer"}createPopupTemplate(t){return jt(this,t)}createQuery(){return new J({where:"1=1",outFields:["*"]})}getField(t){return this.fieldsIndex.get(t)}getFieldDomain(t,e){return null}async queryFeatures(t,e){await this.load();const{resolvedQuery:s,queryEngine:i}=await this._setupQueryObjects(t),r=this.graphicOrigin,n=qt.fromJSON(await i.executeQuery(s.toJSON(),e?.signal));return n.features.forEach(l=>{l.sourceLayer=this,l.origin=r}),n}async queryFeaturesJSON(t,e){await this.load();const{resolvedQuery:s,queryEngine:i}=await this._setupQueryObjects(t);return await i.executeQuery(s.toJSON(),e?.signal)}async queryFeatureCount(t,e){await this.load();const{resolvedQuery:s,queryEngine:i}=await this._setupQueryObjects(t);return i.executeQueryForCount(s.toJSON(),e?.signal)}async queryExtent(t={},e){await this.load();const s={...t,returnGeometry:!0},{resolvedQuery:i,queryEngine:r}=await this._setupQueryObjects(s),n=await r.executeQueryForExtent(i.toJSON(),e?.signal);let l;return l=n.extent?.xmin!=null&&n.extent?.xmax!=null&&n.extent?.ymin!=null&&n.extent?.ymax!=null?new de(n.extent):new de,{count:n.count,extent:l}}async queryObjectIds(t,e){await this.load();const s=J.from(t);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const r=await this.parentCompositeLayer.dataManager.getData(s,this,e);i=this.loadQueryEngine(r)}return await i.executeQueryForIds(s.toJSON(),e?.signal)}async applyEdits(t){if(!this.parentCompositeLayer.dataManager.knowledgeGraph)throw new H("knowledge-graph-sublayer:no-knowledge-graph","ApplyEdits cannot be executed because the parent does not have a Knowledge Graph model.  This is usually caused by the layer not yet being loaded");const e=await ti(t,this);e.options={cascadeDelete:!0,cascadeProvenanceDelete:!!this.parent?.knowledgeGraph.serviceDefinition.supportsProvenance||void 0};const s=await ps(this.parentCompositeLayer.dataManager.knowledgeGraph,e),i=si(s,this.graphTypeName),r={addedFeatures:i.addFeatureResults,updatedFeatures:i.updateFeatureResults,deletedFeatures:i.deleteFeatureResults,addedAttachments:i.addAttachmentResults,deletedAttachments:i.deleteAttachmentResults,updatedAttachments:i.updateAttachmentResults,exceededTransferLimit:!1,historicMoment:new Date,edits:void 0};return this.emit("edits",r),this.emit("apply-edits",{result:Promise.resolve(r)}),this.parentCompositeLayer.type==="link-chart"&&await this.parentCompositeLayer.refreshLinkChartCache([...r.addedFeatures.map(n=>n.globalId),...r.updatedFeatures.map(n=>n.globalId),...r.deletedFeatures.map(n=>n.globalId)]),i}loadQueryEngine(t){const e=new ds({geometryType:ee.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),s=new us({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:ee.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:e});return s.featureStore.addMany(t),s}async refreshCachedQueryEngine(){const t=await this.parentCompositeLayer.dataManager.getData(new J({where:"1=1",outFields:[R]}),this);this._cachedQueryEngine=this.loadQueryEngine(t)}load(t){return this.addResolvingPromise(this.parent.load(t).then(()=>Pt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(t,e){const s=J.from(t),i=s.geometry;if(i&&!i.spatialReference?.isWGS84&&(await pe(i.spatialReference,Q),s.geometry=ie(i instanceof rt||i instanceof Gt||i instanceof Ut?i:i.extent,Q)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:s,queryEngine:this._cachedQueryEngine};const r=await this.parentCompositeLayer.dataManager.getData(s,this,e);return{resolvedQuery:s,queryEngine:this.loadQueryEngine(r)}}};function ai(t,e,s){const i=[["ESRI__AGGREGATION_COUNT",be],["ESRI__ORIGIN_ID",ue],["ESRI__DESTINATION_ID",ce],["ESRI__LAYOUT_GEOMETRY",_e]];try{for(const r of t)for(const[n,l]of i)r.labelExpression=r.labelExpression?.replaceAll(n,l),r.labelExpressionInfo?.expression&&(r.labelExpressionInfo.expression=r.labelExpressionInfo.expression.replaceAll(n,l))}catch(r){it.getLogger(this).warn("Error updating labelingInfo",r)}return as(t,e,s)}y([h(O(A(zt)))],f.prototype,"blendMode",void 0),y([h({readOnly:!0})],f.prototype,"capabilities",null),y([h({readOnly:!0})],f.prototype,"userHasUpdateItemPrivileges",null),y([h({type:Boolean})],f.prototype,"editingEnabled",null),y([h()],f.prototype,"isTable",null),y([h({json:{origins:{"web-scene":{write:!1}},write:te()}})],f.prototype,"charts",void 0),y([h({readOnly:!0})],f.prototype,"defaultPopupTemplate",null),y([h({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],f.prototype,"definitionExpression",void 0),y([h(O(A(Ht)))],f.prototype,"displayFilterEnabled",void 0),y([h(O(A(Qt)))],f.prototype,"displayFilterInfo",void 0),y([h(O(A(Wt)))],f.prototype,"effect",void 0),y([h()],f.prototype,"elevationInfo",void 0),y([h(O(A(Bt)))],f.prototype,"featureEffect",void 0),y([h(O(A(Vt)))],f.prototype,"featureReduction",null),y([h()],f.prototype,"fields",null),y([h()],f.prototype,"formTemplate",null),y([h()],f.prototype,"geometryType",null),y([h()],f.prototype,"geometryFieldName",null),y([h({readOnly:!0})],f.prototype,"graphicOrigin",null),y([h({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],f.prototype,"graphType",void 0),y([h({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],f.prototype,"graphTypeName",null),y([h()],f.prototype,"hasM",null),y([h()],f.prototype,"hasZ",null),y([h({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],f.prototype,"id",void 0),y([h({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],f.prototype,"labelsVisible",void 0),y([h({type:[Y],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:ai,write:te()}})],f.prototype,"labelingInfo",null),y([h({readOnly:!0,json:{read:!1,write:{writer(t,e){switch(this.parentCompositeLayer?.type){case"link-chart":e.layerType="LinkChartSubLayer";break;case"knowledge-graph":e.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],f.prototype,"layerType",void 0),y([h(O(A(Jt)))],f.prototype,"legendEnabled",void 0),y([h(O(A(Zt)))],f.prototype,"maxScale",void 0),y([h(O(A(Yt)))],f.prototype,"minScale",void 0),y([h()],f.prototype,"objectIdField",void 0),y([h()],f.prototype,"objectType",void 0),y([h(O(A(Kt)))],f.prototype,"opacity",void 0),y([h(O(A(Xt)))],f.prototype,"orderBy",void 0),y([h({clonable:!1})],f.prototype,"parent",void 0),y([h()],f.prototype,"parentCompositeLayer",void 0),y([h(O(A(es)))],f.prototype,"popupEnabled",void 0),y([h({type:ts,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],f.prototype,"popupTemplate",void 0),y([h({type:Number,json:{write:{overridePolicy:se}}})],f.prototype,"refreshInterval",void 0),y([h({types:ss,json:{name:"layerDefinition.drawingInfo.renderer",write:te()}})],f.prototype,"renderer",null),y([h()],f.prototype,"source",void 0),y([h()],f.prototype,"spatialReference",null),y([h()],f.prototype,"templates",null),y([h({type:is,json:{name:"layerDefinition.timeInfo",write:{overridePolicy:se},origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:se}},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:se}}}}})],f.prototype,"timeInfo",null),y([h({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],f.prototype,"title",null),y([rs("title")],f.prototype,"writeTitle",null),y([h({json:{read:!1}})],f.prototype,"type",void 0),y([h(O(A(ns)))],f.prototype,"useViewTime",void 0),y([h({type:Boolean,json:{name:"visibility",write:te()}})],f.prototype,"visible",void 0),f=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],f);export{ze as A,Di as C,ei as F,Li as I,xi as L,f as N,He as P,q as a,Be as b,Qe as c,We as d,Ue as e,vi as f,ki as g,fe as o,Ge as p,Mi as r,Si as w};
